<!DOCTYPE html>
<html lang="en">
<meta charset="utf-8">
<head>
<script src="http://d3js.org/d3.v3.min.js"></script>
  <style type="text/css">
    rect {
        fill-opacity:.8;
    }
  </style>
  <style type="text/css">
    body {
      width: 800px;
      margin: 25px auto;
      font-family: Century Gothic,CenturyGothic,AppleGothic,sans-serif; 
    }    
    rect {
        fill-opacity: 0.8;
    }
    rect:hover {
        fill-opacity: 1;
    }
    text {
        font-size: small;
        fill-opacity: 0.8;
        text-align: right;
    }
    text:hover {
        fill-opacity: 1;
    }
  </style>
</head>
<body>
  <div>
    <strong>Time update:</strong>
    <label id = "min_time"></label><input type="range" name="points" min="" max="" step="1" value="0" id="slider-time" oninput=";"><label id = "max_time"></label>
  </div>
  <div>
    <strong>Filter by:</strong>
    <label><input type="checkbox" name="Americas" value="1" id="filter" onchange"('changed!')"/>Americas</input></label>
    <label><input type="checkbox" name="Africa" value="2" id="filter" />Africa</label>    
    <label><input type="checkbox" name="Asia" value="3" id="filter" />Asia</label>  
    <label><input type="checkbox" name="Europe" value="4" id="filter" />Europe</label>  
    <label><input type="checkbox" name="Oceania" value="5" id="filter" />Oceania</label>                  
  </div>
  <div>
    <strong>Aggregate by:</strong>
    <label><input type="radio" name="Aggregate" value="none" id="no_aggregate" onclick="">None</label>
    <label><input type="radio" name="Aggregate" value="continent" id="aggregate" onclick="">Continent</label>
  </div>
  <div>
    <strong>Sort by:</strong>
    <label><input type="radio" name="Sort" value="gdp" id="sort" checked = "checked" onclick="" >GDP</label>
    <label><input type="radio" name="Sort" value="life_expectancy" id="sort" onclick="">Life Expectancy</label>
    <label><input type="radio" name="Sort" value="population" id="sort" onclick="">Population</label>
  </div>
  <!-- <div>
    <label><input type="checkbox" name="Americas" value="1" id="order" onchange""/>Order</input></label>
  </div> -->
  <script type="text/javascript">
    /*
    var variables = ["name", "continent", "gdp", "life_expectancy", "population", "year"];

    var gdpformat = d3.format("0,.1f");
    var lifeformat = d3.format("0.3r");
    var prefix = d3.formatPrefix(1.25e9);
    */

    var margin = {top: 50, bottom: 10, left:300, right: 50};
    var width = 900 - margin.left - margin.right;
    var height = 1800 - margin.top - margin.bottom;
    
    var order_name = true; 
    var order_value = false; 

    var xScale = d3.scale.linear().range([10, width]);
    var yScale = d3.scale.ordinal().rangeRoundBands([0, height], .8, 0);

    var bar_height = 11;

    var hierarchy = d3.layout.partition()
        .value(function(d) {
            return d.value;
        });

    var xAxis = d3.svg.axis()
        .scale(xScale)
        .orient("top");
 
    var svg = d3.select("body").append("svg")
                .attr("width", width+margin.left+margin.right)
                .attr("height", height+margin.top+margin.bottom);
 
    var g = svg.append("g")
                .attr("transform", "translate("+margin.left+","+margin.top+")");

    svg.append("svg:g")
        .attr("class", "x axis")

    svg.append("svg:g")
        .attr("class", "y axis")
        .append("svg:line")
        .attr("y1", "100%") 

    function filter_year(data) {
        var year = d3.select('#slider-time').property("value");
        var filtered_year = data.filter(function(d) {
            return d.year == year;
          }) 
        return filtered_year;
    }



    function aggregate(data, value){
        var year = d3.select('#slider-time').property("value");
        var filtered_year = filter_year(data);
        var aggregated;

        if (value == "gdp" || value == "population") {
            aggregated = d3.nest()
              .key(function(d) { return d.continent; })
              .rollup(function(leaves) { return {
                "value": d3.sum(leaves, function(d) {return parseFloat(d.value);}),
                "year": year,
              } })
              .entries(filtered_year);
        }
        else if (value == "life_expectancy") {
            aggregated = d3.nest()
              .key(function(d) { return d.continent; })
              .rollup(function(leaves) { return {
                "value": d3.mean(leaves, function(d) {return parseFloat(d.value);}),
                "year": year,
              } })
              .entries(filtered_year);
        }

        flat_results = aggregated.map(function(d, i){
        return {
          continent:d.key,
          value:d.values.value,
          year:d.values.year};
        })
        return flat_results;
    }

    d3.json("data/countries_1995_2012.json", function(data) {
        
        /*
        hierarchy.nodes(data);
        xScale.domain([0, data.value]).nice();
        down(data, 0);
        */
        function buildbars(data, min) {
            data = data.sort(function(a, b) {
                return d3.ascending(a.name,b.name);
            });
            
            var rows = g.append("g")
                .selectAll("g.row")
                .data(data)
                .enter()
                .append("g")
                .attr("class", "row")
 
            var bars = rows
                .append("rect")
                .attr("class", "background")
                .attr("width", function(d) { 
                    if (d.value != null) {
                    return xScale(d.value);}
                    else {
                        return xScale(min);
                    } })
                .attr("height", bar_height)
                .attr("x", xScale(min))
                .attr("y", function(d, i) { return (bar_height+2)*i; })
                .attr("fill", function(d) {
                    if (d.continent == "Americas") {
                        return "#FFAA88";
                    }
                    if (d.continent == "Africa"){
                        return "#FFE088";
                    }
                    if (d.continent == "Asia"){
                        return "#FF8F02";
                    }
                    if (d.continent == "Europe"){
                        return "#8D92EA";
                    }
                    if (d.continent == "Oceania"){
                        return "#82BFE7";
                    }
                })

                

            rows.append("text")
                .attr("x", function(d) { return (xScale(min) - 20); })
                .attr("y", function(d, i) { return (bar_height+2)*i; })
                .attr("text-anchor", "end")
                .attr("dx", 3)
                .attr("dy", "0.65em")
                .text(function(d) { 
                    if (d.name == null) {
                        return d.continent; 
                    }
                    else {
                        return d.name;
                    }})
            
        }

        // flattening the data
        var flat = [];
  
        var n = 0;
        for (var i = 0; i < data.length; i++) {
          for (var j = 0; j < data[i].years.length; j++) {
            flat[n] = {
              'name': data[i].name,
              'continent': data[i].continent,
              'gdp': data[i].years[j].gdp,
              'life_expectancy': data[i].years[j].life_expectancy,
              'population': data[i].years[j].population,
              'year': data[i].years[j].year
            };
            n++;
          }
        }

        // finding the range of years
        var min_year = d3.min(flat, function(d){
            return d.year;})
        var max_year = d3.max(flat, function(d){
            return d.year;})

        d3.select('#slider-time')
            .property("min", min_year)
            .property("max", max_year);

        d3.select('#min_time')
          .text(min_year);

        d3.select('#max_time')
          .text(max_year);


        without_nulls_gdp = flat.filter(function(d) {
                return (d.gdp != null);});
        
        var min_value_gdp = d3.min(without_nulls_gdp, function(d) { return d.gdp; } );
        var max_value_gdp = d3.max(without_nulls_gdp, function(d) { return d.gdp; } );

        xScale.domain([min_value_gdp, max_value_gdp])
        yScale.domain(flat.map(function(d) { return d.name; }));
        
        
        var default_data = flat.map(function(d){
            return {
                name: d.name,
                year: d.year,
                continent: d.continent,
                value: d.gdp
            }
        });

        var filtered_year_default = filter_year(default_data);

        buildbars(filtered_year_default, min_value_gdp);
        
        var new_data = default_data;

        d3.selectAll("#sort").on("change", function() {

            var use_value = d3.select(this).attr("value");
            
            if(d3.select("#aggregate").node().checked) {
                sorted = sort_value(flat, use_value);
                aggregate_rows = aggregate(sorted, use_value);
                update(aggregate_rows);
            } 
            else {
                var filtered_year = sort_value(flat, use_value);
                update(filtered_year);

            }
        });

        d3.selectAll("#aggregate").on("change", function() {
            var use_value;
            d3.selectAll("#sort").each(function(){
                if (d3.select(this).node().checked) {
                    use_value = d3.select(this).attr("value");
                }
            });
            sorted = sort_value(flat, use_value);
            aggregate_rows = aggregate(sorted, use_value);
            update(aggregate_rows);
        });

        d3.selectAll("#no_aggregate").on("change", function() {
            var use_value;
            d3.selectAll("#sort").each(function(){
                if (d3.select(this).node().checked) {
                    use_value = d3.select(this).attr("value");
                }
            });
            var filtered_year = sort_value(flat, use_value);
            update(filtered_year);
        });

        d3.selectAll('#slider-time').on("input",function(){
            var use_value;
            d3.selectAll("#sort").each(function(){
                if (d3.select(this).node().checked) {
                    use_value = d3.select(this).attr("value");
                }
            });
            if(d3.select("#aggregate").node().checked) {
                sorted = sort_value(flat, use_value);
                aggregate_rows = aggregate(sorted, use_value);
                update(aggregate_rows);
            } 
            else {
                sorted = sort_value(flat, use_value);
                update(sorted);
            }
        });

        d3.selectAll("#filter").on("change", function(d) {
            var use_value;
            d3.selectAll("#sort").each(function(){
                if (d3.select(this).node().checked) {
                    use_value = d3.select(this).attr("value");
                }
            });
            if(d3.select("#aggregate").node().checked) {
                sorted = sort_value(flat, use_value);
                aggregate_rows = aggregate(sorted, use_value);
                update(aggregate_rows);
            } 
            else {
                sorted = sort_value(flat, use_value);
                update(sorted);
            }
        });

        function sort_value(flat, use_value) {

            if (use_value == "gdp") {
                new_data = flat.map(function(d){
                    return {
                        name: d.name,
                        year: d.year,
                        continent: d.continent,
                        value: d.gdp
                    }
                });
                filtered_year = filter_year(new_data);
            }
            else if (use_value == "life_expectancy") {
                new_data = flat.map(function(d){
                    return {
                        name: d.name,
                        year: d.year,
                        continent: d.continent,
                        value: d.life_expectancy
                    }
                });
                filtered_year = filter_year(new_data);
            }
            else if (use_value == "population") {
                new_data = flat.map(function(d){
                    return {
                        name: d.name,
                        year: d.year,
                        continent: d.continent,
                        value: d.population
                    }
                });
                filtered_year = filter_year(new_data);
            }
            return filtered_year;
        }

        function update(new_data) {

            var continent = ["", "", "", "", "", ""];
            var year = d3.select('#slider-time').property("value");
            var filtered_year = filter_year(new_data);
            var empty = true;

            d3.selectAll("input").each(function(d,i) {
                empty = false;
                if(d3.select(this).attr("type") == "checkbox" && d3.select(this).node().checked) {
                continent[i] = d3.select(this).attr("name");
                }    
                var empty_count = 0;
                for (var j = 0; j < 6; j++) {
                  if (continent[j] == "") {
                    empty_count++;
                  }
                }
                if (empty_count == 6) {
                  empty = true;
                }
            })

            var filtered_data = filtered_year.filter(function(d) {
                if (!empty) { 
                  var need = (d["continent"] == continent[0]);
                  for (var i = 1; i <6 ; i++) {
                    need = need || (d["continent"] == continent[i]);
                  }
                  return need;
                }
                else {
                  return true;
                }
            })

            without_nulls = filtered_data.filter(function(d) {
                return (d.value != null);});
            
            var min = d3.min(without_nulls, function(d) { return d.value; } );
            var max = d3.max(without_nulls, function(d) { 
                return d.value; } );

            xScale.domain([min, max]);
            
            filtered_data = filtered_data.sort(function(a, b) {
                return d3.ascending(a.name,b.name);
            });

            // DATA JOIN

            var rect = g.selectAll("rect")
                .data(filtered_data);

            var text = g.selectAll("text")
                .data(filtered_data);

            // ENTER
            // new elements
            rect.enter().append("rect")
                .attr("height", bar_height)
                .attr("x", xScale(min))

            text.enter().append("text")
                .attr("x", function(d) { return (xScale(min) - 20); })
                .attr("text-anchor", "end")
                .attr("dx", 3)
                .attr("dy", "0.65em")

            // ENTER + UPDATE
            // both old and new elements
            rect
                .attr("y", function(d, i) { return (bar_height+2)*i; })
                .attr("width", function(d) { 
                    if (d.value != null) {
                    return xScale(d.value);}
                    else {
                        return xScale(min_value_gdp);
                    }})
                .attr("fill", function(d) {
                    if (d.continent == "Americas") {
                        return "#FFAA88";
                    }
                    if (d.continent == "Africa"){
                        return "#FFE088";
                    }
                    if (d.continent == "Asia"){
                        return "#FF8F02";
                    }
                    if (d.continent == "Europe"){
                        return "#8D92EA";
                    }
                    if (d.continent == "Oceania"){
                        return "#82BFE7";
                    }
                })



            text
                .text(function(d) { 
                    if (d.name == null) {
                        return d.continent; 
                    }
                    else {
                        return d.name;
                    }
                })
                .attr("y", function(d, i) { return (bar_height+2)*i;})
                .attr("fill",function(d) { 
                    if (d.value == null) {
                        return "#d3d3d3";
                    }
                }) 
            // EXIT
            // elements that aren't associated with data
            rect.exit().remove();
            text.exit().remove();
        }
    });
    



  </script>
</body>
</html>